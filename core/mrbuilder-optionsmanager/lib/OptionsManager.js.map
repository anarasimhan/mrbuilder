{"version":3,"sources":["../src/OptionsManager.js"],"names":["split","value","Array","isArray","filter","Boolean","DEFAULT_ALL","OptionsManager","prefix","envPrefix","confPrefix","rcFile","all","env","process","argv","cwd","info","console","warn","_require","require","plugins","shift","toUpperCase","toLowerCase","key","def","ret","paths","topPackage","args","NODE_ENV","resolveFromPkgDir","pkg","file","relto","name","resolve","resolveConfig","pluginConfig","envOverride","presets","options","ignoreRc","newOption","plugin","config","parent","opt","Option","optionsManager","processOpts","override","has","set","main","map","pluginName","pluginOpts","isLocal","startsWith","localName","forEach","scan","preset","presetName","processEnv","pluginsName","presetsName","length","Error","pluginConf","parts","enabled","get"],"mappings":"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","file":"OptionsManager.js","sourcesContent":["import { basename, join, resolve } from 'path';\nimport {\n    configOrBool, get, info, parseJSON, parseValue, set, warn\n} from 'mrbuilder-utils';\nimport { merge, nameConfig, select } from './util';\n\nconst split = (value = '') => (Array.isArray(value) ? value\n    : value.split(/,\\s*/)).filter(Boolean);\n\nexport const DEFAULT_ALL = ['DEBUG',\n    'ENABLE',\n    'DISABLE',\n    'PLUGINS',\n    'PRESETS',\n    'MODULE_DIR'\n];\n\nexport default class OptionsManager {\n\n    plugins = new Map();\n\n    constructor({\n                    prefix,\n                    envPrefix,\n                    confPrefix,\n                    rcFile,\n                    all = DEFAULT_ALL,\n                    env = process.env,\n                    argv = process.argv,\n                    cwd = process.cwd,\n                    info = console.info || console.warn,\n                    warn = console.warn,\n                    _require = require\n                } = {}) {\n        if (!prefix) {\n            prefix = basename(argv[1]).split('-').shift()\n        }\n        prefix     = prefix.toUpperCase();\n        envPrefix  = envPrefix || prefix.toUpperCase();\n        confPrefix = confPrefix || prefix.toLowerCase();\n        rcFile     = `.${confPrefix}rc`;\n\n\n        this.env = (key, def) => {\n            const ret = env[key.toUpperCase()];\n            if (ret === null || ret === void(0)) {\n                return def;\n            }\n            return ret;\n        };\n\n        this.cwd        = (...paths) => resolve(this.env('MODULE_DIR', cwd()),\n            ...paths);\n        this.topPackage = _require(this.cwd('package.json'));\n\n\n        this.warn = (...args) => {\n            warn(`WARN [${prefix.toLowerCase()}]`, ...args);\n\n        };\n\n        this.info = (...args) => {\n            if (this.env(`${envPrefix}_DEBUG`)) {\n                info(`INFO [${prefix.toLowerCase()}]`, ...args);\n            }\n        };\n\n        this.info('NODE_ENV is', env.NODE_ENV || 'not set');\n\n        const resolveFromPkgDir = (pkg, file, ...relto) => {\n            if (!pkg || this.topPackage.name === pkg) {\n                if (file === 'package.json') {\n                    pkg = this.cwd(file);\n                }\n                return this.cwd(file, ...relto);\n            }\n            if (file === 'package.json') {\n                return _require.resolve(join(pkg, file))\n            }\n            return resolve(_require.resolve(join(pkg, 'package.json')), '..',\n                file, ...relto);\n        };\n\n        const resolveConfig = (pkg) => {\n            if (typeof pkg === 'string') {\n                if (pkg === this.topPackage.name) {\n                    pkg = this.topPackage;\n                } else {\n                    pkg = _require(`${pkg}/package.json`);\n                }\n            }\n            const pluginConfig = pkg[confPrefix]\n                                 || parseJSON(\n                    resolveFromPkgDir(pkg.name, rcFile))\n                                 || {};\n\n            const envOverride = pluginConfig.env\n                                && pluginConfig.env[env.NODE_ENV] || {};\n            return {\n                presets : select(envOverride.presets, pluginConfig.presets),\n                options : select(envOverride.options, pluginConfig.options),\n                plugins : select(envOverride.plugins, pluginConfig.plugins),\n                ignoreRc: select(envOverride.ignoreRc, pluginConfig.ignoreRc),\n            };\n        };\n\n\n        const newOption = (name, plugin, config, parent) => {\n            if (config === false) {\n                return false;\n            }\n            const opt          = new Option(name, plugin, config, parent);\n            opt.optionsManager = this;\n            return opt;\n        };\n\n        const processOpts = (name, {\n            plugin,\n            presets,\n            plugins,\n            ignoreRc\n        } = {}, options, pkg, parent, override) => {\n            if (this.plugins.has(name)) {\n                return;\n            }\n\n\n            if (options === false) {\n                this.plugins.set(name, false);\n                return;\n            } else {\n                if (plugin !== false) {\n                    plugin = plugin || name;\n                    if (name === this.topPackage.name) {\n\n                        plugin = resolveFromPkgDir(\n                            this.topPackage.name, this.topPackage.main\n                                                  || './index.js');\n\n                    }\n                    this.plugins.set(name,\n                        newOption(name, plugin, options, pkg));\n                }\n            }\n            if (plugins) {\n                plugins.map(plugin => {\n                    const [pluginName, pluginOpts] = nameConfig(plugin);\n                    if (pluginName === this.topPackage.name) {\n                        return;\n                    }\n                    if (pluginOpts === false) {\n                        this.plugins.set(pluginName, false);\n                        return;\n                    }\n                    const isLocal = pluginName.startsWith('.');\n                    if (isLocal) {\n                        const localName = join(name, pluginName);\n                        this.plugins.set(localName,\n                            newOption(localName, require.resolve(localName),\n                                pluginOpts,\n                                pkg));\n                        return;\n                    }\n                    return [pluginName, override || pluginOpts];\n                }).filter(Boolean).forEach(([pluginName, pluginOpts]) => {\n                    scan(ignoreRc, pkg, pluginName, pluginOpts);\n                })\n            }\n\n            if (presets) {\n                //presets all get the same configuration.\n                presets.forEach(preset => {\n                    const [presetName, config] = nameConfig(preset);\n                    scan(ignoreRc, pkg, presetName, void(0), config)\n                });\n            }\n        };\n        const processEnv  = (prefix = '') => {\n            const pluginsName = `${envPrefix}_${prefix}PLUGINS`;\n            const presetsName = `${envPrefix}_${prefix}PRESETS`;\n            const plugins     = split(this.env(pluginsName, ''));\n            const presets     = split(this.env(presetsName, ''));\n            if ((plugins.length || presets.length)) {\n                this.info('process from env', pluginsName, plugins,\n                    presetsName, presets);\n                processOpts(`${envPrefix}_${prefix}ENV`,\n                    { plugins, presets, plugin: false },\n                    void(0),\n                    this.topPackage);\n            }\n        };\n        const scan        = (ignoreRc, parent, name, options, override) => {\n            this.info('scanning', name);\n\n            const pkg = name === this.topPackage.name ? this.topPackage\n                : _require(`${name}/package.json`);\n            if (Array.isArray(name)) {\n                throw new Error(\n                    `${name} can not be an array import from ${parent\n                                                               && parent.name}`);\n\n            }\n\n            const pluginConf = resolveConfig(pkg);\n\n            options = merge(name, options || pluginConf.options, { env, argv });\n\n            processOpts(name, pluginConf, options, pkg, parent,\n                override);\n        };\n\n\n        processEnv();\n        scan(false, this.topPackage, this.topPackage.name);\n        //ALLOW for fallbacks when tooling wants to signal things.\n        processEnv('INTERNAL_');\n\n    }\n\n\n    config(name, def) {\n        const parts = name.split('.', 2);\n        const key   = parts.shift();\n        if (!this.enabled(key)) {\n            //if not enabled no default.\n            return;\n        }\n        const config = this.plugins.get(key).config;\n        return get(config, parts.shift(), def);\n    }\n\n    enabled(name) {\n        return !!this.plugins.get(name);\n    }\n\n    //make nice stringify\n    toJSON() {\n        return {\n            name   : this.topPackage.name,\n            plugins: this.plugins\n        }\n    }\n}\n\nclass Option {\n    constructor(name,\n                plugin,\n                config,\n                parent) {\n        this.name   = name;\n        this.plugin = plugin;\n        this.config = config;\n        this.parent = parent;\n    }\n\n    info(...args) {\n        (this.optionsManager || console).info(`- ${this.name}`,\n            ...args);\n    }\n\n    warn(...args) {\n        (this.optionsManager || console).warn(`- ${this.name}`, ...args);\n    }\n\n    toJSON() {\n        return {\n            name  : this.name,\n            plugin: typeof this.plugin === 'function' ? (this.plugin.name\n                                                         || '[function]')\n                : this.plugin,\n            config: this.config,\n            parent: `[${this.parent && this.parent.name}]`\n        }\n    }\n}\n"]}